generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Club {
  id                     String            @id @default(uuid())
  legal_name             String?
  tax_id                 String?
  fiscal_address         String?
  default_vat            Float?
  currency               String?
  invoice_prefix         String?
  invoice_counter        Int               @default(1)
  phone_whatsapp         String?
  bizum_payee            String?
  price_per_player_cents Int               @default(500)
  slot_minutes           Int               @default(30)
  buffer_minutes         Int               @default(0)
  min_advance_minutes    Int               @default(60)
  max_advance_days       Int               @default(14)
  open_hours             String            @default("{}")
  display_name           String?
  logo_url               String?
  created_at             DateTime          @default(now())
  blocks                 Block[]
  bookings               Booking[]
  classes                ClassEvent[]
  closeouts              CloseoutPeriod[]
  courts                 Court[]
  invitations            Invitation[]
  invoices               Invoice[]
  members                Member[]
  movements              Movement[]
  prices                 Price[]
  rates                  Rate[]
  supplier_invoices      SupplierInvoice[]
  tournaments            Tournament[]
  users                  User[]
  min_deposit_cents      Int               @default(0)
  hold_minutes           Int               @default(10)
  audit_logs             AuditLog[]
}

model AuditLog {
  id          String   @id @default(uuid())
  club_id     String
  user_id     String
  action      String   // e.g., "CREATE_TOURNAMENT", "ARCHIVE_TOURNAMENT", "DELETE_TOURNAMENT"
  resource    String   // e.g., "Tournament"
  resource_id String
  details     String?
  created_at  DateTime @default(now())
  club        Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
}

model Member {
  id             String  @id @default(uuid())
  club_id        String
  full_name      String
  whatsapp_phone String
  status         String  @default("APPROVED")
  user_id        String?
  club           Club    @relation(fields: [club_id], references: [id])
  invitations    Invitation[]
  bookings       Booking[] @relation("MemberToBooking")

  @@unique([club_id, whatsapp_phone])
  @@index([club_id])
}

model Invitation {
  id              String   @id @default(uuid())
  club_id         String
  token           String   @unique
  member_id       String
  inviter_user_id String?
  status          String   @default("PENDING") // PENDING, USED, EXPIRED, REVOKED
  expires_at      DateTime
  used_at         DateTime?
  created_at      DateTime @default(now())
  club            Club     @relation(fields: [club_id], references: [id])
  member          Member   @relation(fields: [member_id], references: [id])
  inviter         User?    @relation("InviterUser", fields: [inviter_user_id], references: [id])

  @@index([club_id])
}

model Booking {
  id            String         @id @default(uuid())
  club_id       String
  court_id      String
  user_id       String?
  guest_name      String?
  phone           String?
  payment_method  String?
  invoice_id    String?
  tournament_id String?
  recurring_id  String?
  start_at      DateTime
  end_at        DateTime
  status        String         @default("PENDING_PAYMENT")
  strategy      String         @default("SPLIT")
  price_cents   Int
  total_cents   Int
  hold_expires_at DateTime?
  source          String         @default("RECEPCION") // PWA, RECEPCION, OWNER
  amount_total    Int?           @default(0)
  amount_paid      Int?           @default(0)
  payment_status  String         @default("PENDIENTE") // PENDING, PARCIAL, PAID, FAILED
  court_ids       String[]       @default([])
  member_id       String?
  created_at      DateTime       @default(now())
  
  member          Member?        @relation("MemberToBooking", fields: [member_id], references: [id])
  tournament      Tournament?    @relation(fields: [tournament_id], references: [id])
  invoice       Invoice?       @relation(fields: [invoice_id], references: [id])
  user          User?          @relation(fields: [user_id], references: [id])
  court         Court          @relation(fields: [court_id], references: [id])
  club          Club           @relation(fields: [club_id], references: [id])
  shares        PaymentShare[]
  payments      Payment[]

  @@index([club_id])
  @@index([court_id, start_at, end_at])
}

model PaymentShare {
  id         String    @id @default(uuid())
  booking_id String
  user_id    String?
  amount     Int
  status     String    @default("INITIATED")
  proof_note String?
  paid_at    DateTime?
  created_at DateTime  @default(now())
  booking    Booking   @relation(fields: [booking_id], references: [id])

  @@index([booking_id])
}

model Payment {
  id             String    @id @default(uuid())
  booking_id     String
  provider       String    @default("BIZUM") // BIZUM, CASH, CARD
  provider_ref   String?
  amount_cents   Int
  status         String    @default("PENDING") // PENDING, SUCCESS, FAILED
  created_at     DateTime  @default(now())
  booking        Booking   @relation(fields: [booking_id], references: [id])

  @@index([booking_id])
}

model Block {
  id       String   @id @default(uuid())
  club_id  String
  court_id String
  start_at DateTime
  end_at   DateTime
  reason   String?
  club     Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
}

model ClassEvent {
  id       String   @id @default(uuid())
  club_id  String
  court_id String
  start_at DateTime
  end_at   DateTime
  title    String
  club     Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
}

model Tournament {
  id                     String                  @id @default(uuid())
  club_id                String
  name                   String
  date                   DateTime
  points_per_match       Int                     @default(24)
  duration_minutes       Int                     @default(180)
  match_duration_minutes Int                     @default(21)
  price_per_person       Int
  status                 String                  @default("OPEN")
  created_at             DateTime                @default(now())
  bookings               Booking[]
  club                   Club                    @relation(fields: [club_id], references: [id])
  matches                TournamentMatch[]
  participants           TournamentParticipant[]

  @@index([club_id])
}

model TournamentParticipant {
  id            String     @id @default(uuid())
  tournament_id String
  user_id       String?
  name          String?
  total_points  Int        @default(0)
  user          User?      @relation(fields: [user_id], references: [id])
  tournament    Tournament @relation(fields: [tournament_id], references: [id])

  @@unique([tournament_id, user_id])
  @@index([tournament_id])
}

model TournamentMatch {
  id            String     @id @default(uuid())
  tournament_id String
  round         Int
  court_id      String?
  player1_id    String
  player2_id    String
  player3_id    String
  player4_id    String
  score_12      Int?
  score_34      Int?
  tournament    Tournament @relation(fields: [tournament_id], references: [id])

  @@index([tournament_id])
}

model User {
  id                      String                  @id @default(uuid())
  email                   String                  @unique
  password_hash           String
  club_id                 String
  role                    String                  @default("USER")
  created_at              DateTime                @default(now())
  full_name               String?
  bookings                Booking[]
  tournament_participants TournamentParticipant[]
  club                    Club                    @relation(fields: [club_id], references: [id])
  sent_invitations        Invitation[]            @relation("InviterUser")
}

model Court {
  id           String    @id @default(uuid())
  club_id      String
  name         String
  surface_type String?
  lighting     Boolean   @default(false)
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now())
  bookings     Booking[]
  club         Club      @relation(fields: [club_id], references: [id])
  prices       Price[]

  @@index([club_id])
}

model Rate {
  id         String   @id @default(uuid())
  club_id    String
  name       String
  price      Float
  duration   Int      @default(60)
  created_at DateTime @default(now())
  club       Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
}

model Price {
  id          String   @id @default(uuid())
  club_id     String
  court_id    String?
  hourly_rate Int
  valid_days  String
  start_time  String
  end_time    String
  created_at  DateTime @default(now())
  court       Court?   @relation(fields: [court_id], references: [id])
  club        Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
  @@index([court_id])
}

model Invoice {
  id          String        @id @default(uuid())
  club_id     String
  number      Int
  total_cents Int
  status      String        @default("ISSUED")
  created_at  DateTime      @default(now())
  bookings    Booking[]
  club        Club          @relation(fields: [club_id], references: [id])
  items       InvoiceItem[]

  @@unique([club_id, number])
  @@index([club_id])
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoice_id  String
  description String
  quantity    Int      @default(1)
  unit_price  Int
  total_price Int
  created_at  DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoice_id], references: [id])

  @@index([invoice_id])
}

model CloseoutPeriod {
  id                String   @id @default(uuid())
  club_id           String
  from              DateTime
  to                DateTime
  total_revenue     Float
  total_hours       Float
  reservation_count Int
  notes             String?
  created_at        DateTime @default(now())
  created_by        String
  club              Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
}

model Movement {
  id           String   @id @default(uuid())
  club_id      String
  amount_cents Int
  concept      String
  category     String?
  date         DateTime @default(now())
  created_at   DateTime @default(now())
  club         Club     @relation(fields: [club_id], references: [id])

  @@index([club_id, date])
}

model SupplierInvoice {
  id             String   @id @default(uuid())
  club_id        String
  provider_name  String
  category       String
  amount_cents   Int
  date           DateTime @default(now())
  invoice_number String?
  attachment_url String?
  status         String   @default("PENDING")
  created_at     DateTime @default(now())
  club           Club     @relation(fields: [club_id], references: [id])

  @@index([club_id])
  @@index([date])
}
